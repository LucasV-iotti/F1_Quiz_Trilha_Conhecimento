<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1" name="viewport"/>
<title>F1 Quiz â€“ Trilha do Conhecimento</title>
<link href="style.css" rel="stylesheet"/>
<style>
@import url('https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;800&display=swap');
:root{
  --bg:#0b0c10;--card:#15171c;--text:#e9edf1;--muted:#b2b8c2;--red:#e10600;--yellow:#ffdd00;--green:#2ecc71;
  --glass-bg:rgba(21,23,28,.5);--glass-brd:rgba(255,255,255,.12);--glow:0 0 24px rgba(225,6,0,.25);
}
*{box-sizing:border-box} html,body{height:100%}
body{margin:0;font-family:'Montserrat',system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;color:var(--text);
  background: radial-gradient(1200px 600px at 110% -10%, #1b1f26 0%, var(--bg) 45%);}
.app-header{position:sticky;top:0;z-index:5;background:linear-gradient(90deg,var(--card),transparent);
  padding:8px 16px;border-bottom:1px solid #23262c}
.flag{height:12px;background:repeating-linear-gradient(45deg,#fff 0 10px,#e10600 10px 20px);border-radius:2px;box-shadow:var(--glow)}
.brand{display:flex;gap:12px;align-items:center;font-weight:800;letter-spacing:.5px}
.brand small{font-weight:600;color:var(--muted)}
main{max-width:1100px;margin:auto;padding:16px}
.card{background:var(--glass-bg);border:1px solid var(--glass-brd);border-radius:16px;padding:16px;box-shadow:var(--glow)}
.grid{display:grid;gap:16px}.grid-2{grid-template-columns:1fr}@media(min-width:900px){.grid-2{grid-template-columns:1fr 1fr}}
.btn{appearance:none;border:0;padding:12px 16px;border-radius:10px;font-weight:800;cursor:pointer;color:#0b0c10;
  background:linear-gradient(180deg,#ffdd00,#ffb000);box-shadow:0 6px 0 #cc8b00}
.btn:disabled{opacity:.6;cursor:not-allowed;box-shadow:none}
.btn.red{background:linear-gradient(180deg,#ff6961,#ff3b30);box-shadow:0 6px 0 #b22317;color:#fff}
.btn.ghost{background:transparent;border:1px solid var(--glass-brd);color:var(--text)}
.status{font-size:.85rem;color:var(--muted);margin-left:6px}
.badge{display:inline-block;padding:4px 8px;border-radius:999px;font-weight:700;font-size:.8rem}
.badge.green{background:#1f8e4d33;color:#2ecc71;border:1px solid #2ecc71}
.badge.red{background:#a2201a33;color:#e10600;border:1px solid #e10600}
.screen{display:none}.screen.active{display:block}
.hud{display:flex;align-items:center;justify-content:space-between;gap:8px}
.progress{height:10px;background:#1a1d24;border-radius:999px;overflow:hidden;border:1px solid #272b33}
.progress>i{display:block;height:100%;width:0%;background:linear-gradient(90deg,#2ecc71,#ffdd00)}
.question{font-size:1.15rem;font-weight:800}
.options{display:grid;gap:10px;grid-template-columns:repeat(2,1fr)}
.option{padding:12px;border:1px solid #2a2f38;border-radius:10px;cursor:pointer;background:#161a21;transition:.2s transform,.2s background,.2s border-color}
.option:hover{transform:translateY(-2px);border-color:#3a4250}
.option.correct{background:#172a1d;border-color:#2ecc71}
.option.wrong{background:#2a1717;border-color:#e10600}
.podium{display:flex;gap:16px;align-items:end;justify-content:center}
.podium .col{width:120px;background:#161a21;border:1px solid #2a2f38;border-radius:12px;text-align:center;padding:10px}
.confetti{position:fixed;inset:0;pointer-events:none}
</style>
</head>
<body>
<header class="app-header">
  <div class="brand">
    <div class="flag" aria-hidden="true"></div>
    <div><div>F1 Quiz â€“ Trilha do Conhecimento</div><small>Hora da Largada</small></div>
  </div>
</header>

<main>
  <!-- TELA: INÃCIO -->
  <section id="screen-start" class="screen active">
    <div class="card grid grid-2">
      <div>
        <h2>ğŸ IdentificaÃ§Ã£o do Piloto</h2>
        <label>Nome<br/>
          <input id="playerName" type="text" placeholder="Ex.: Ayrton Senna" minlength="2"
                 style="width:100%;padding:10px;border-radius:8px;border:1px solid #2a2f38;background:#0f1218;color:#e9edf1">
        </label>
        <div id="nameStatus" class="status">MÃ­nimo de 2 caracteres.</div>

        <div style="height:10px"></div>

        <label>CPF<br/>
          <input id="playerCPF" type="text" inputmode="numeric" placeholder="000.000.000-00"
                 style="width:100%;padding:10px;border-radius:8px;border:1px solid #2a2f38;background:#0f1218;color:#e9edf1">
        </label>
        <div id="cpfStatus" class="status">Formato: 000.000.000-00 (validaÃ§Ã£o automÃ¡tica).</div>

        <div style="height:14px"></div>
        <button id="btnStart" class="btn" disabled>Iniciar Largada</button>
      </div>
      <div>
        <h3>Pit Stop: Regras da Corrida</h3>
        <ul>
          <li>ğŸ 10 perguntas. Uma volta por pergunta.</li>
          <li>âœ… Acertou? <strong>+10 pts</strong></li>
          <li>âš ï¸ Errou? <strong>âˆ’5 pts</strong></li>
          <li>â© AvanÃ§o automÃ¡tico apÃ³s responder.</li>
          <li>ğŸ“ˆ PÃ³dio no final com pontuaÃ§Ã£o/acertos/erros.</li>
        </ul>
        <span class="badge">+10 Acerto â€¢ âˆ’5 Erro</span>
        <div style="height:10px"></div>
        <button id="btnHowTo" class="btn ghost">ComeÃ§ar a Corrida</button>
      </div>
    </div>
  </section>

  <!-- TELA: QUIZ -->
  <section id="screen-quiz" class="screen">
    <div class="card">
      <div class="hud">
        <div><span id="lap">1/10 voltas</span> â€¢ <span id="score">PontuaÃ§Ã£o: 0</span></div>
        <div class="progress" style="width:45%"><i id="bar"></i></div>
        <div class="badge green" id="goFlag">GO!</div>
      </div>
      <div style="height:12px"></div>
      <div class="question" id="question">â€¦</div>
      <div class="options" id="options"></div>
    </div>
  </section>

  <!-- TELA: FINAL -->
  <section id="screen-end" class="screen">
    <div class="card">
      <h2>ğŸ Bandeirada Final</h2>
      <p><strong>Piloto:</strong> <span id="finalName">â€”</span><br/>
         <strong>CPF:</strong> <span id="finalCPF">â€”</span></p>
      <p><strong>PontuaÃ§Ã£o:</strong> <span id="finalScore">0</span> pts<br/>
         <strong>Acertos:</strong> <span id="finalHits">0</span><br/>
         <strong>Erros:</strong> <span id="finalMiss">0</span></p>

      <div class="podium" aria-label="pÃ³dio">
        <div class="col"><div>ğŸ¥ˆ</div><small>Bom</small></div>
        <div class="col" style="height:140px"><div>ğŸ¥‡</div><small>Excelente</small></div>
        <div class="col"><div>ğŸ¥‰</div><small>Regular</small></div>
      </div>

      <div style="height:12px"></div>
      <button id="btnRestart" class="btn" aria-label="Jogar novamente">Jogar novamente</button>
    </div>
  </section>

  <div aria-hidden="true" class="confetti" id="confetti"></div>
</main>

<!-- SDK Supabase -->
https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2

<script>
// ===== Helpers DOM =====
const $  = (sel) => document.querySelector(sel);
const $$ = (sel) => document.querySelectorAll(sel);

// ===== SUPABASE =====
const supabaseUrl = 'https://phmpoizlkrwzouydkopp.supabase.co';
const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBobXBvaXpsa3J3em91eWRrb3BwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYxNDExOTMsImV4cCI6MjA3MTcxNzE5M30.fcbEM3ekrx6UP-MPWA7xqLzvxPihzEJQhCQxEKt1Qf0';
const TABLE = 'quiz_f1_trilha_do_conhecimento';

let supabase;
if (typeof window.supabase !== 'undefined') {
  supabase = window.supabase.createClient(supabaseUrl, supabaseKey);
} else {
  console.error('Supabase nÃ£o carregou corretamente');
}

// Retry leve para inicializaÃ§Ã£o mais robusta
function delay(ms){ return new Promise(r=>setTimeout(r, ms)); }
async function initSupabase(maxTries=5){
  if (supabase) return true;
  for (let i=0;i<maxTries;i++){
    if (typeof window.supabase !== 'undefined'){
      try{
        supabase = window.supabase.createClient(supabaseUrl, supabaseKey);
        return true;
      }catch(e){ console.error('Falha ao criar cliente Supabase:', e); }
    }
    await delay(200);
  }
  console.error('Supabase nÃ£o carregou corretamente apÃ³s tentativas.');
  return false;
}

// ===== ESTADO =====
let state = { playerName:'', cpf:'', score:0, current:0, hits:0, miss:0, startTime:null, endTime:null, answers:[] };

// ===== PERGUNTAS =====
const questions = [
  { q:'1. Qual Ã© um dos principais riscos do uso do cartÃ£o de crÃ©dito?', options:['A) NÃ£o poder parcelar compras','B) Entrar no crÃ©dito rotativo com juros altos','C) NÃ£o ter limite para compras','D) NÃ£o poder usar em compras online'], answer:1 },
  { q:'2. O cheque especial Ã© um tipo de crÃ©dito ________ oferecido pelo banco, ligado diretamente Ã  conta corrente.', options:['A) parcelado','B) automÃ¡tico','C) garantido','D) consignado'], answer:1 },
  { q:'3. Qual Ã© um benefÃ­cio do emprÃ©stimo pessoal?', options:['A) NÃ£o pagar juros','B) Parcelas variÃ¡veis','C) Dinheiro rÃ¡pido para emergÃªncias','D) NÃ£o comprometer a renda mensal'], answer:2 },
  { q:'4. Quando o cliente atrasa o pagamento, alÃ©m dos juros, multa e encargos, o ________ Ã© reduzido.', options:['A) limite do cartÃ£o','B) score de crÃ©dito','C) valor da fatura','D) prazo de pagamento'], answer:1 },
  { q:'5. Qual Ã© a consequÃªncia de usar o cheque especial com frequÃªncia?', options:['A) Aumento do limite','B) ReduÃ§Ã£o dos juros','C) Aumento dos custos devido a juros altos','D) ReduÃ§Ã£o do saldo devedor'], answer:2 },
  { q:'6. O que Ã© portabilidade de crÃ©dito?', options:['A) Transferir dÃ­vida para outro banco com melhores condiÃ§Ãµes','B) Pagar dÃ­vida com milhas','C) Cancelar a dÃ­vida sem custo','D) Trocar crÃ©dito por produtos'], answer:0 },
  { q:'7. Qual Ã© uma boa prÃ¡tica ao usar o cartÃ£o de crÃ©dito?', options:['A) Pagar apenas o mÃ­nimo da fatura','B) Controlar gastos e pagar o total da fatura','C) Utilizar o rotativo sempre que possÃ­vel','D) Ignorar a data de vencimento'], answer:1 },
  { q:'8. O crÃ©dito consignado Ã© descontado diretamente de onde?', options:['A) Conta poupanÃ§a','B) SalÃ¡rio ou benefÃ­cio','C) CartÃ£o de dÃ©bito','D) Conta salÃ¡rio de terceiros'], answer:1 },
  { q:'9. Para reduzir juros, uma boa alternativa Ã©:', options:['A) Parcelar a fatura do cartÃ£o no mÃ¡ximo possÃ­vel','B) Antecipar parcelas quando houver desconto','C) Usar o rotativo com frequÃªncia','D) Deixar contas atrasarem para negociar depois'], answer:1 },
  { q:'10. O que significa inadimplÃªncia?', options:['A) Pagar adiantado','B) Ficar com pagamento em dia','C) Deixar de pagar uma dÃ­vida no prazo','D) Trocar a forma de pagamento'], answer:2 }
];

// ===== VALIDAÃ‡ÃƒO NOME/CPF =====
const cpfMask = (v)=>v.replace(/\D/g,'').replace(/(\d{3})(\d)/,'$1.$2').replace(/(\d{3})(\d)/,'$1.$2').replace(/(\d{3})(\d{1,2})$/,'$1-$2').slice(0,14);
const isValidCPF = (cpf)=>{
  const v = cpf.replace(/\D/g,''); if (v.length!==11 || /^(\d)\1+$/.test(v)) return false;
  const calc=(slice)=>{let s=0;for(let i=0;i<slice;i++)s+=parseInt(v[i])*((slice+1)-i);const m=(s*10)%11;return (m===10?0:m)===parseInt(v[slice]);};
  return calc(9)&&calc(10);
};

// ===== UI =====
function showScreen(sel){ $$('.screen').forEach(s=>s.classList.remove('active')); $(sel).classList.add('active'); }
function setProgress(cur,total){ $('#lap').textContent=`${cur}/${total} voltas`; $('#bar').style.width=`${Math.round((cur-1)*100/total)}%`; }
function updateScore(){ $('#score').textContent = `PontuaÃ§Ã£o: ${state.score}`; }

// ===== QUIZ =====
function renderQuestion(){
  const q=questions[state.current];
  $('#question').textContent=q.q;
  const wrap=$('#options'); wrap.innerHTML='';
  q.options.forEach((opt,idx)=>{
    const btn=document.createElement('button'); btn.className='option'; btn.textContent=opt;
    btn.onclick=()=>choose(idx); wrap.appendChild(btn);
  });
  setProgress(state.current+1, questions.length);
}

function choose(idx){
  const q=questions[state.current]; const nodes=$$('.option'); nodes.forEach(n=>n.disabled=true);
  const correct= idx===q.answer; nodes[idx].classList.add(correct?'correct':'wrong');
  if(correct){state.score+=10;state.hits++;}else{state.score-=5;state.miss++;}
  state.answers.push({i:state.current+1, sel:idx, ok:correct});
  updateScore();
  setTimeout(()=>{ state.current++; if(state.current<questions.length){renderQuestion();} else { finishQuiz(); } }, 600);
}

async function startSequenceThenBegin(){
  showScreen('#screen-quiz'); updateScore(); state.startTime=Date.now(); renderQuestion();
}

function finishQuiz(){
  state.endTime=Date.now();
  $('#finalName').textContent=state.playerName; $('#finalCPF').textContent=state.cpf;
  $('#finalScore').textContent=state.score; $('#finalHits').textContent=state.hits; $('#finalMiss').textContent=state.miss;
  showScreen('#screen-end');
  (async()=>{ await salvarResultadoSupabase(); })();
}

// ===== SALVAR NO SUPABASE (com menos chance de erro) =====
async function salvarResultadoSupabase() {
  try {
    if (!navigator.onLine) {
      console.error('Sem conexÃ£o de rede (offline)');
      mostrarStatusSalvamento('Sem internet (offline)', false);
      return;
    }
    const ok = await initSupabase();
    if (!ok) {
      mostrarStatusSalvamento('Supabase nÃ£o carregou', false);
      return;
    }

    const tempoFinal = state.endTime ? Math.round((state.endTime - state.startTime) / 1000) : 0;
    const dados = {
      nome: state.playerName, cpf: state.cpf, pontuacao: state.score,
      acertos: state.hits, erros: state.miss, tempo_final: tempoFinal, respostas: state.answers
    };

    console.log('Tentando salvar dados:', dados);

    // returning: 'minimal' evita necessidade de SELECT na policy
    const { error } = await supabase.from(TABLE).insert([dados], { returning: 'minimal' });

    if (error) {
      console.error('Erro ao salvar no Supabase:', {
        message: error.message, code: error.code, details: error.details, hint: error.hint
      });
      mostrarStatusSalvamento('Erro ao salvar resultado', false);
    } else {
      console.log('Resultado salvo com sucesso');
      mostrarStatusSalvamento('Resultado salvo com sucesso!', true);
    }
  } catch (err) {
    console.error('Erro inesperado:', err);
    mostrarStatusSalvamento('Erro ao conectar com banco de dados', false);
  }
}

// ===== STATUS (toast) =====
function mostrarStatusSalvamento(msg, ok){
  const el=document.createElement('div'); el.textContent=msg;
  el.style.cssText='position:fixed;bottom:20px;right:20px;padding:10px 12px;border-radius:10px;'+
    `background:${ok?'#2ecc71':'#e10600'};color:#fff;font-weight:800;box-shadow:0 8px 24px rgba(0,0,0,.35);z-index:9999`;
  document.body.appendChild(el); setTimeout(()=>el.remove(), 4000);
}

// ===== HEALTHCHECK =====
async function verificarConexaoSupabase() {
  try {
    if (!navigator.onLine) { mostrarStatusConexao('Sem internet (offline)', false); return; }
    const ok = await initSupabase();
    if (!ok) { mostrarStatusConexao('Supabase nÃ£o carregou', false); return; }

    const { error } = await supabase.from(TABLE).select('id').limit(1);
    if (!error) {
      mostrarStatusConexao('Supabase: ONLINE', true);
    } else {
      console.error('Healthcheck error:', error);
      const msg = /permission|policy|rls|privilege|401|403/i.test(((error && error.message)||'')+' '+((error && error.details)||''))
        ? 'Supabase: ONLINE (RLS bloqueando)'
        : 'Supabase: OFFLINE/erro';
      mostrarStatusConexao(msg, false);
    }
  } catch (e) {
    console.error('Erro ao verificar Supabase:', e);
    mostrarStatusConexao('Erro de conexÃ£o', false);
  }
}
function mostrarStatusConexao(texto, sucesso){
  const el=document.createElement('div'); el.textContent=texto;
  el.style.cssText=`
    position:fixed;top:10px;right:10px;padding:6px 12px;background:${sucesso?'#2ecc71':'#e10600'};
    color:#fff;font-weight:bold;border-radius:8px;box-shadow:0 6px 18px rgba(0,0,0,.35);z-index:9999`;
  document.body.appendChild(el); setTimeout(()=>el.remove(), 3500);
}

// ===== INÃCIO: eventos =====
$('#playerName').addEventListener('input', (e)=>{
  const ok = e.target.value.trim().length >= 2;
  $('#nameStatus').textContent = ok ? 'Ok!' : 'MÃ­nimo de 2 caracteres.';
  $('#nameStatus').className = 'status ' + (ok ? 'badge green' : '');
  state.playerName = e.target.value.trim();
  validateStart();
});
$('#playerCPF').addEventListener('input', (e)=>{
  e.target.value = cpfMask(e.target.value);
  const ok = isValidCPF(e.target.value);
  $('#cpfStatus').textContent = ok ? 'CPF vÃ¡lido' : 'Formato: 000.000.000-00';
  $('#cpfStatus').className = 'status ' + (ok ? 'badge green' : '');
  state.cpf = e.target.value.trim();
  validateStart();
});
function validateStart(){
  const ok = state.playerName.length >= 2 && isValidCPF(state.cpf);
  $('#btnStart').disabled = !ok;
}
$('#btnStart').addEventListener('click', async ()=>{
  await verificarConexaoSupabase();
  startSequenceThenBegin();
});
$('#btnHowTo').addEventListener('click', ()=>$('#playerName').focus());
$('#btnRestart').addEventListener('click', ()=>{
  state={playerName:'',cpf:'',score:0,current:0,hits:0,miss:0,startTime:null,endTime:null,answers:[]};
  $('#playerName').value=''; $('#playerCPF').value=''; $('#btnStart').disabled=true;
  $('#nameStatus').className='status'; $('#cpfStatus').className='status'; showScreen('#screen-start');
});
</script>
</body>
</html>
